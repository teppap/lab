# -*- coding: utf-8 -*-
"""bert2

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1RAqX08pEfG-LyLzkHgvGpUu4VlZtBiKy
"""
#Start-CELL1---------------------------------------------------------------------------
# File: use_bert_classifier.py
from transformers import pipeline

# --- 1. โหลด Classifier จาก Cache ---
print("--- 1. กำลังเรียกใช้งาน Classifier... ---")
# หากเคยรัน script แรกแล้ว ขั้นตอนนี้จะเร็วมากเพราะดึงจาก cache
classifier = pipeline("zero-shot-classification",
                      model="airesearch/wangchanberta-base-att-spm-uncased",
                      device=-1)
print("✅ Classifier พร้อมใช้งาน!")

# --- 2. กำหนดหมวดหมู่ที่ต้องการจำแนก ---
security_labels = [
    "การโจมตีแบบฟิชชิ่ง (Phishing)",
    "ข่าวปลอม (Fake News)",
    "การแจ้งเตือนช่องโหว่ (Vulnerability Alert)",
    "มัลแวร์เรียกค่าไถ่ (Ransomware)",
    "ข้อความทั่วไป (Normal)"
]

# --- 3. ข้อความที่ต้องการทดสอบ ---
texts_to_analyze = [
    "เราตรวจพบกิจกรรมการลงชื่อเข้าใช้ที่ผิดปกติในบัญชี Google ของคุณ หากนี่ไม่ใช่คุณ โปรดรักษาความปลอดภัยบัญชีของคุณทันที",
    "คำสั่งซื้อ Foodpanda ของคุณมีปัญหา โปรดยืนยันรายละเอียดการชำระเงินของคุณอีกครั้ง",
    "เตือนภัย! ดื่มน้ำอัดลมพร้อมกับยาแก้ปวด ทำให้ไตวายเฉียบพลัน",
    "นักโบราณคดีไทยขุดพบปิรามิดโบราณในจังหวัดบุรีรัมย์ อายุกว่า 3,000 ปี",
    "ประกาศจากรัฐบาล! งดเก็บค่าไฟฟ้าทุกครัวเรือนเป็นเวลา 3 เดือน เริ่มเดือนหน้า",
    "Oracle ได้ปล่อย Critical Patch Update (CPU) เพื่อแก้ไขช่องโหว่ความปลอดภัยร้ายแรงใน Java",
    "แจ้งเตือนผู้ใช้ Android: พบมัลแวร์ตัวใหม่แพร่กระจายผ่านแอปฯ นอก Play Store สามารถขโมยข้อมูลธนาคารได้",
    "คำเตือน: โปรแกรม 7-Zip เวอร์ชันเก่ามีช่องโหว่ที่อนุญาตให้ยกระดับสิทธิ์ได้ รีบอัปเดตด่วน",
    "ไฟล์ข้อมูลพนักงานทั้งหมดถูกเข้ารหัสแล้ว หากต้องการกู้คืน ติดต่อเราภายใน 24 ชั่วโมงเพื่อต่อรองราคา",
    "อย่าคิดว่าจะหนีได้ เรามีข้อมูลของลูกค้าคุณทั้งหมด ถ้าไม่อยากเสียชื่อเสียง โอนเงินมาตามที่อยู่ที่แจ้งไว้",
    "ไฟล์ของคุณถูกล็อคด้วยนามสกุล .LOCKEDBYEVILCORP การพยายามกู้คืนด้วยตัวเองจะทำให้ข้อมูลเสียหายถาวร",
    "นักเรียนกลุ่ม 7 หน้าตาดีทุกคน",
    "วันนี้ฝนตกหนักมาก อย่าลืมพกร่มกันด้วยนะ"
]

print("\n--- 2. ผลการวิเคราะห์ข้อความ ---")
for text in texts_to_analyze:
    result = classifier(text, security_labels, multi_label=False)
    print(f"\nข้อความ: '{text}'")
    print(f" -> ผลลัพธ์: {result['labels'][0]} (ความมั่นใจ: {result['scores'][0]:.2%})")
#END-CELL1---------------------------------------------------------------------------

#Start-CELL2---------------------------------------------------------------------------
# =================================================================
# ขั้นตอนที่ 1: ติดตั้ง Libraries ที่จำเป็น
# =================================================================
# !pip install -q transformers[torch] datasets scikit-learn

import pandas as pd
from io import StringIO
from sklearn.model_selection import train_test_split
from datasets import Dataset, DatasetDict
from transformers import (
    AutoTokenizer,
    AutoModelForSequenceClassification,
    TrainingArguments,
    Trainer,
    pipeline
)
import torch

# =================================================================
# ขั้นตอนที่ 2: เตรียม Dataset
# =================================================================
csv_data = """text,label
"เรียนผู้ใช้บริการ SCB, พบการเข้าสู่ระบบที่น่าสงสัยในบัญชีของท่าน กรุณาคลิกเพื่อยืนยันตัวตนด่วน",Phishing
"พัสดุจาก Lazada ของคุณกำลังรอการยืนยันที่อยู่ โปรดอัปเดตข้อมูลเพื่อให้เราจัดส่งต่อได้",Phishing
"บัญชี Apple ID ของคุณถูกล็อคเพื่อความปลอดภัย โปรดปลดล็อคและยืนยันข้อมูลส่วนตัวของคุณที่นี่",Phishing
"คุณคือผู้โชคดี! ได้รับ Shopee Coins ฟรี 500 เหรียญ กดรับสิทธิ์ของคุณก่อนหมดเขต",Phishing
"แจ้งจากไปรษณีย์ไทย: พัสดุของคุณไม่สามารถจัดส่งได้เนื่องจากน้ำหนักเกิน โปรดชำระค่าธรรมเนียมเพิ่มเติม",Phishing
"รหัสผ่าน Line ของคุณกำลังจะหมดอายุใน 24 ชั่วโมง กรุณาตั้งรหัสผ่านใหม่ผ่านลิงก์นี้",Phishing
"แจ้งเตือนการเข้าระบบ Netflix จากอุปกรณ์ที่ไม่รู้จัก หากไม่ใช่คุณโปรดรักษาความปลอดภัยบัญชีทันที",Phishing
"เราตรวจพบบัญชีของคุณมีการใช้งานที่ผิดปกติ เพื่อหลีกเลี่ยงการถูกระงับถาวร โปรดตรวจสอบบัญชีของคุณ",Phishing
"ข้อเสนอเงินกู้ด่วน 100,000 บาท อนุมัติใน 5 นาที ไม่เช็คเครดิตบูโร สนใจแอดไลน์เลย",Phishing
"อีเมลของคุณมีพื้นที่เต็มแล้ว กรุณาอัปเกรดพื้นที่เก็บข้อมูลเพื่อรับอีเมลต่อไป",Phishing
"ยินดีด้วย! คุณได้รับรางวัลพิเศษจากกิจกรรมล่าสุดของเรา โปรดยืนยันเพื่อรับรางวัล",Phishing
"อัปเดตเงื่อนไขการให้บริการของ Facebook โปรดอ่านและยอมรับเงื่อนไขใหม่เพื่อใช้งานต่อ",Phishing
"ด่วน! ครม. มีมติแจกเงินเยียวยารอบใหม่ 5,000 บาท เข้าทุกบัญชี เริ่มพรุ่งนี้",Fake News
"แพทย์แผนไทยค้นพบสมุนไพรมหัศจรรย์ ต้มดื่มรักษามะเร็งได้ทุกระยะ หายขาดใน 30 วัน",Fake News
"แชร์เตือนภัย! ห้ามกินส้มตำกับทุเรียนพร้อมกัน เสี่ยงสารพิษทำปฏิกิริยาในร่างกายถึงตาย",Fake News
"ฮือฮา! พบมนุษย์ต่างดาวที่เขาค้อ ชาวบ้านแห่พิสูจน์",Fake News
"องค์การอนามัยโลก (WHO) ประกาศไม่ให้ฉีดวัคซีนโควิดอีกต่อไป เพราะไม่มีประโยชน์",Fake News
"นักวิทยาศาสตร์จากมหาวิทยาลัยชื่อดังเผย โลกจะเข้าสู่ยุคน้ำแข็งอีกครั้งในปีหน้า",Fake News
"ภาพหลุด! คู่รักดาราวัยรุ่นชื่อดัง แอบไปเที่ยวทะเลด้วยกันสองต่อสอง",Fake News
"เตือนภัย! ห้ามเปิดแอร์ขณะที่พัดลมเพดานทำงาน เพราะจะทำให้คอมเพรสเซอร์ระเบิด",Fake News
"ล่าสุด! กรมทางหลวงประกาศยกเลิกเก็บค่าผ่านทางมอเตอร์เวย์ทั้งหมดถาวร",Fake News
"นักวิจัยญี่ปุ่นพบว่าการนอนหลับหลัง 22:00 น. เป็นสาเหตุหลักของโรคความจำเสื่อม",Fake News
"ธนาคารแห่งประเทศไทยประกาศใช้ธนบัตรรุ่นใหม่ พลาสติกทั้งหมด เริ่มสัปดาห์หน้า",Fake News
"พบช่องโหว่ความปลอดภัยร้ายแรง CVE-2025-9999 ในระบบปฏิบัติการ Windows 11 ทุกเวอร์ชัน",Vulnerability Alert
"Google ได้ออกอัปเดตฉุกเฉินสำหรับ Chrome เพื่อแก้ไขช่องโหว่ Zero-day ที่กำลังถูกโจมตีอยู่ในขณะนี้",Vulnerability Alert
"สำหรับนักพัฒนา: พบช่องโหว่ Remote Code Execution ในไลบรารี Apache Struts แนะนำให้อัปเกรดทันที",Vulnerability Alert
"Mozilla ปล่อย Firefox เวอร์ชันใหม่เพื่อแก้ไขช่องโหว่ความปลอดภัยหลายรายการ รวมถึงช่องโหว่ระดับสูง",Vulnerability Alert
"แจ้งเตือนผู้ใช้งาน: โปรดอัปเดตแพตช์ความปลอดภัยสำหรับ Adobe Acrobat Reader โดยด่วนที่สุด",Vulnerability Alert
"Microsoft ได้ปล่อยแพตช์ความปลอดภัยประจำเดือน ขอให้ผู้ดูแลระบบรีบดำเนินการอัปเดตบนเซิร์ฟเวอร์",Vulnerability Alert
"พบช่องโหว่ในโปรโตคอล Wi-Fi WPA3 ที่อาจอนุญาตให้ผู้โจมตีดักจับข้อมูลได้",Vulnerability Alert
"Cisco Talos เผยแพร่รายงานการค้นพบช่องโหว่ใหม่ในเราเตอร์รุ่นยอดนิยม",Vulnerability Alert
"แจ้งเตือน: ไลบรารี OpenSSL เวอร์ชันเก่ามีช่องโหว่ที่อาจส่งผลกระทบต่อการเชื่อมต่อ HTTPS",Vulnerability Alert
"Apple ปล่อยอัปเดต iOS 19.5.1 เพื่อแก้ไขช่องโหว่ความปลอดภัยที่สำคัญ",Vulnerability Alert
"Intel ออก Microcode Update เพื่อลดความเสี่ยงจากช่องโหว่ Spectre และ Meltdown",Vulnerability Alert
"ไฟล์งานและข้อมูลสำคัญทั้งหมดของคุณถูกเข้ารหัสแล้วด้วยอัลกอริทึม AES-256",Ransomware
"ต้องการไฟล์คืนไหม? อย่าพยายามทำอะไรเอง ส่ง Bitcoin จำนวน 0.5 BTC มาตามที่อยู่นี้ภายใน 72 ชั่วโมง",Ransomware
"คอมพิวเตอร์ของคุณถูกล็อคโดยกลุ่ม Lazarus เราได้ข้อมูลของคุณทั้งหมด ถ้าไม่อยากให้มันถูกเผยแพร่ จงจ่ายเงิน",Ransomware
"ไฟล์ของคุณทั้งหมดถูกต่อท้ายด้วยนามสกุล .crypted อย่าเปลี่ยนชื่อไฟล์! ติดต่อเราที่ evil@proton.me เพื่อรับคีย์ถอดรหัส",Ransomware
"คุณมีเวลา 24 ชั่วโมงในการชำระเงิน มิฉะนั้นราคาจะเพิ่มขึ้นเป็นสองเท่า และไฟล์จะถูกลบถาวรในหนึ่งสัปดาห์",Ransomware
"อย่าเสียเวลาไปหาโปรแกรมแก้ฟรี มันไม่มีทางได้ผล มีเพียงเราเท่านั้นที่ถอดรหัสไฟล์ของคุณได้",Ransomware
"ระบบเครือข่ายของบริษัทคุณถูกเจาะแล้ว เราได้ทำการเข้ารหัสเซิร์ฟเวอร์ไฟล์ทั้งหมด ติดต่อเราเพื่อเจรจา",Ransomware
"เราได้เห็นข้อมูลทางการเงินที่ละเอียดอ่อนของคุณแล้ว ถ้าไม่อยากให้ลูกค้าของคุณรู้เรื่องนี้ โอนเงินมาซะ",Ransomware
"นาฬิกากำลังเดิน... ทุกๆ ชั่วโมงที่ผ่านไป ไฟล์บางส่วนของคุณจะถูกลบอย่างถาวร",Ransomware
"นี่คือคำเตือนครั้งสุดท้าย การพยายามกู้ข้อมูลด้วยตัวเองจะทำให้ไฟล์เสียหายอย่างถาวร",Ransomware
"การชำระเงินของคุณคือการรับประกันว่าคุณจะได้ข้อมูลคืน",Ransomware
"พรุ่งนี้มีประชุมตอน 10 โมงเช้านะ อย่าลืมเตรียมสไลด์ด้วย",Normal
"เย็นนี้กินอะไรดี สั่งพิซซ่ากันไหม?",Normal
"นักเรียนกลุ่มที่เป็นเลขคี่ มักจะหน้าตาดีเสมอ",Normal
"ส่งรายงานสรุปการประชุมให้ทางอีเมลแล้วนะ ฝากตรวจทานด้วย",Normal
"ใครอยู่ใกล้ห้องครัวบ้าง ฝากปิดไฟให้หน่อย",Normal
"วันหยุดยาวนี้ไปเที่ยวไหนกันดี ทะเลหรือภูเขา?",Normal
"ช่วยตรวจสอบเอกสารใบเสนอราคาให้หน่อยครับว่าถูกต้องไหม",Normal
"วันนี้รถติดมาก อาจจะเข้าออฟฟิศสายหน่อยนะ",Normal
"กาแฟอร่อยดีนะร้านนี้ ไว้มากันอีก",Normal
"อย่าลืมรดน้ำต้นไม้ที่ระเบียงด้วยนะ",Normal
"ใครมีที่ชาร์จไอโฟนให้ยืมบ้าง แบตจะหมดแล้ว",Normal
"ตั๋วหนังเรื่องใหม่จองเรียบร้อยแล้ว เจอกันหน้าโรงหนัง",Normal
"ช่วยส่งเบอร์ติดต่อของฝ่ายบัญชีให้หน่อยครับ",Normal"""

df = pd.read_csv(StringIO(csv_data))
labels = df['label'].unique().tolist()
label2id = {label: i for i, label in enumerate(labels)}
id2label = {i: label for i, label in enumerate(labels)}
df['label_id'] = df['label'].map(label2id)
train_df, test_df = train_test_split(df, test_size=0.2, random_state=42, stratify=df['label'])
train_dataset = Dataset.from_pandas(train_df)
test_dataset = Dataset.from_pandas(test_df)
raw_datasets = DatasetDict({'train': train_dataset,'test': test_dataset})

# =================================================================
# ขั้นตอนที่ 3: Tokenization
# =================================================================
# ⭐️⭐️⭐️ แก้ไขชื่อโมเดลตรงนี้ ⭐️⭐️⭐️
model_checkpoint = "airesearch/wangchanberta-base-att-spm-uncased"
tokenizer = AutoTokenizer.from_pretrained(model_checkpoint)

def tokenize_function(examples):
    return tokenizer(examples["text"], truncation=True, padding="max_length", max_length=128)

tokenized_datasets = raw_datasets.map(tokenize_function, batched=True)
tokenized_datasets = tokenized_datasets.remove_columns(["text", "label", "__index_level_0__"])
tokenized_datasets = tokenized_datasets.rename_column("label_id", "labels")
tokenized_datasets.set_format("torch")

# =================================================================
# ขั้นตอนที่ 4: Fine-Tuning
# =================================================================
model = AutoModelForSequenceClassification.from_pretrained(
    model_checkpoint,
    num_labels=len(labels),
    id2label=id2label,
    label2id=label2id
)

training_args = TrainingArguments(
    output_dir="./cybersecurity-model",
    num_train_epochs=3,
    per_device_train_batch_size=8,
    per_device_eval_batch_size=8,
    eval_strategy="epoch",
    save_strategy="epoch",
    load_best_model_at_end=True,
    logging_steps=1,
    fp16=torch.cuda.is_available(),
    report_to="none", # ⭐️ ปิดการเชื่อมต่อ wandb
)

trainer = Trainer(
    model=model,
    args=training_args,
    train_dataset=tokenized_datasets["train"],
    eval_dataset=tokenized_datasets["test"],
    tokenizer=tokenizer,
)
trainer.train()

#END-CELL2---------------------------------------------------------------------------


#Start-CELL3---------------------------------------------------------------------------
# =================================================================
# ขั้นตอนที่ 5: บันทึกและทดสอบโมเดล
# =================================================================
final_model_path = "./final-cybersecurity-classifier"
trainer.save_model(final_model_path)
finetuned_classifier = pipeline("text-classification", model=final_model_path, device=0 if torch.cuda.is_available() else -1)

test_sentences_unlabeled = [
    "เราตรวจพบกิจกรรมการลงชื่อเข้าใช้ที่ผิดปกติในบัญชี Google ของคุณ หากนี่ไม่ใช่คุณ โปรดรักษาความปลอดภัยบัญชีของคุณทันที",
    "คำสั่งซื้อ Foodpanda ของคุณมีปัญหา โปรดยืนยันรายละเอียดการชำระเงินของคุณอีกครั้ง",
    "เตือนภัย! ดื่มน้ำอัดลมพร้อมกับยาแก้ปวด ทำให้ไตวายเฉียบพลัน",
    "นักโบราณคดีไทยขุดพบปิรามิดโบราณในจังหวัดบุรีรัมย์ อายุกว่า 3,000 ปี",
    "ประกาศจากรัฐบาล! งดเก็บค่าไฟฟ้าทุกครัวเรือนเป็นเวลา 3 เดือน เริ่มเดือนหน้า",
    "Oracle ได้ปล่อย Critical Patch Update (CPU) เพื่อแก้ไขช่องโหว่ความปลอดภัยร้ายแรงใน Java",
    "แจ้งเตือนผู้ใช้ Android: พบมัลแวร์ตัวใหม่แพร่กระจายผ่านแอปฯ นอก Play Store สามารถขโมยข้อมูลธนาคารได้",
    "คำเตือน: โปรแกรม 7-Zip เวอร์ชันเก่ามีช่องโหว่ที่อนุญาตให้ยกระดับสิทธิ์ได้ รีบอัปเดตด่วน",
    "ไฟล์ข้อมูลพนักงานทั้งหมดถูกเข้ารหัสแล้ว หากต้องการกู้คืน ติดต่อเราภายใน 24 ชั่วโมงเพื่อต่อรองราคา",
    "อย่าคิดว่าจะหนีได้ เรามีข้อมูลของลูกค้าคุณทั้งหมด ถ้าไม่อยากเสียชื่อเสียง โอนเงินมาตามที่อยู่ที่แจ้งไว้",
    "ไฟล์ของคุณถูกล็อคด้วยนามสกุล .LOCKEDBYEVILCORP การพยายามกู้คืนด้วยตัวเองจะทำให้ข้อมูลเสียหายถาวร",
    "นักเรียนกลุ่ม 7 หน้าตาดีทุกคน",
    "วันนี้ฝนตกหนักมาก อย่าลืมพกร่มกันด้วยนะ"
]

print("\n--- ผลลัพธ์หลังการ Fine-tuning ---")
for text in test_sentences_unlabeled:
    result = finetuned_classifier(text)
    print(f"\nข้อความ: '{text}'")
    print(f" -> ผลลัพธ์: {result[0]['label']} (ความมั่นใจ: {result[0]['score']:.2%})")
#END-CELL3---------------------------------------------------------------------------